<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reels Tracker</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#ffffff">
</head>
<body class="min-h-screen bg-white text-gray-900">
  <div id="root"></div>

  <!-- React 18 UMD + Babel for JSX -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    const TZ = "Europe/Copenhagen";
    const STORAGE_KEY = "reels-tracker-v1";

    const todayKey = (date = new Date()) =>
      date.toLocaleDateString("en-CA", { timeZone: TZ });

    const addDays = (date, n) => {
      const d = new Date(date);
      d.setDate(d.getDate() + n);
      return d;
    };

    const startOfMonth = (date) => {
      const d = new Date(date);
      d.setDate(1);
      d.setHours(0,0,0,0);
      return d;
    };
    const endOfMonth = (date) => {
      const d = new Date(date);
      d.setMonth(d.getMonth() + 1);
      d.setDate(0);
      d.setHours(23,59,59,999);
      return d;
    };
    const monthLabel = (date) =>
      date.toLocaleDateString(undefined, { month: "long", year: "numeric", timeZone: TZ });

    const getMonthDays = (date) => {
      const start = startOfMonth(date);
      const days = [];
      const last = endOfMonth(date).getDate();
      for (let i = 1; i <= last; i++) {
        const d = new Date(start);
        d.setDate(i);
        days.push(d);
      }
      return days;
    };

    const getWeekdayIndex0Mon = (date) => (date.getDay() + 6) % 7; // Mon=0

    const loadData = () => {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return { entries: {}, bestStreak: 0 };
        const obj = JSON.parse(raw);
        return { entries: obj.entries || {}, bestStreak: obj.bestStreak || 0 };
      } catch {
        return { entries: {}, bestStreak: 0 };
      }
    };
    const saveData = (data) => localStorage.setItem(STORAGE_KEY, JSON.stringify(data));

    function Stat({ label, value, hint }) {
      return (
        <div className="bg-white border border-gray-200 rounded-xl p-3">
          <div className="text-xs uppercase tracking-wide text-gray-500">{label}</div>
          <div className="text-lg font-semibold">{value}</div>
          {hint && <div className="text-xs text-gray-500 mt-1">{hint}</div>}
        </div>
      );
    }

    function LegendDot({ className, label }) {
      return (
        <div className="flex items-center gap-2">
          <div className={\`w-4 h-4 rounded-md border \${className}\`} />
          <span>{label}</span>
        </div>
      );
    }
    function Legend() {
      return (
        <div className="flex items-center gap-4 mt-3 text-sm text-gray-600">
          <LegendDot className="bg-green-100 border-green-200" label="Didn't watch" />
          <LegendDot className="bg-red-100 border-red-200" label="Watched" />
          <LegendDot className="bg-gray-100 border-gray-200" label="No entry" />
        </div>
      );
    }

    function MonthGrid({ date, entries }) {
      const days = getMonthDays(date);
      const label = monthLabel(date);
      const pad = getWeekdayIndex0Mon(days[0]);
      const blanks = Array.from({ length: pad }, (_, i) => <div key={\`b\${i}\`} />);

      return (
        <div className="bg-white border border-gray-200 rounded-2xl p-3">
          <div className="flex items-baseline justify-between mb-2">
            <div className="font-semibold">{label}</div>
            <div className="text-xs text-gray-500">Mon–Sun</div>
          </div>
          <div className="grid grid-cols-7 gap-1 text-center">
            {["M","T","W","T","F","S","S"].map((d) => (
              <div key={d} className="text-[10px] uppercase text-gray-400">{d}</div>
            ))}
            {blanks}
            {days.map((d) => {
              const key = todayKey(d);
              const status = entries[key];
              let cls = "bg-gray-100 text-gray-600 border-gray-200";
              let tooltip = "No entry";
              if (status === true) { cls = "bg-green-100 text-green-900 border-green-200"; tooltip = "Didn't watch"; }
              else if (status === false) { cls = "bg-red-100 text-red-900 border-red-200"; tooltip = "Watched"; }
              return (
                <div
                  key={key}
                  title={\`\${d.toLocaleDateString(undefined, { day: "numeric", month: "short", timeZone: TZ })} — \${tooltip}\`}
                  className={\`aspect-square flex items-center justify-center text-sm border rounded-lg \${cls}\`}
                >
                  {d.getDate()}
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    function ReelsTrackerApp() {
      const [{ entries, bestStreak }, setState] = useState(loadData);
      useEffect(() => { saveData({ entries, bestStreak }); }, [entries, bestStreak]);

      const today = useMemo(() => todayKey(), []);
      const todayStatus = entries[today];

      const currentStreak = useMemo(() => {
        let streak = 0;
        const startDate = todayStatus === true ? new Date() : addDays(new Date(), -1);
        let cursor = todayKey(startDate);
        while (entries[cursor] === true) {
          streak += 1;
          const d = new Date(startDate);
          d.setDate(startDate.getDate() - streak);
          cursor = todayKey(d);
        }
        return streak;
      }, [entries, todayStatus]);

      const projectedStreakIfSuccessToday =
        todayStatus === undefined ? currentStreak + 1 : currentStreak;

      const recomputeBest = (map) => {
        const daysBack = 730;
        let best = 0, streak = 0;
        for (let i = 0; i <= daysBack; i++) {
          const d = addDays(new Date(), -i);
          const key = todayKey(d);
          if (map[key] === true) { streak += 1; best = Math.max(best, streak); }
          else { streak = 0; }
        }
        return best;
      };

      const markToday = (didNotWatch) => {
        setState((s) => {
          const newEntries = { ...s.entries, [today]: didNotWatch };
          const newBest = recomputeBest(newEntries);
          return { entries: newEntries, bestStreak: newBest };
        });
      };

      const undoToday = () => {
        setState((s) => {
          const { [today]: _, ...rest } = s.entries;
          const newBest = recomputeBest(rest);
          return { entries: rest, bestStreak: newBest };
        });
      };

      const monthDates = [0, -1, -2].map((m) => {
        const d = new Date();
        d.setDate(1);
        d.setMonth(d.getMonth() + m);
        return d;
      });

      return (
        <div className="min-h-screen p-6 md:p-10">
          <div className="max-w-3xl mx-auto">
            <header className="mb-6">
              <h1 className="text-3xl md:text-4xl font-bold tracking-tight">Reels Tracker</h1>
              <p className="text-gray-600 mt-1">A tiny daily check-in to break the habit, keep a streak, and see progress.</p>
            </header>

            <div className="bg-gray-50 border border-gray-200 rounded-2xl p-5 shadow-sm mb-6">
              <div className="flex items-center justify-between flex-wrap gap-3">
                <div>
                  <div className="text-sm uppercase tracking-wide text-gray-500">Today</div>
                  <div className="text-2xl font-semibold">
                    {new Date().toLocaleDateString(undefined, {
                      weekday: "long", year: "numeric", month: "short", day: "numeric", timeZone: TZ
                    })}
                  </div>
                </div>
                <div className="flex gap-2">
                  <button
                    className={\`px-4 py-2 rounded-xl border text-sm font-medium transition shadow-sm \${todayStatus === true ? "bg-green-100 border-green-300" : "bg-white border-gray-300 hover:bg-gray-100"}\`}
                    onClick={() => markToday(true)}
                  >
                    I <span className="font-bold">didn't</span> watch
                  </button>
                  <button
                    className={\`px-4 py-2 rounded-xl border text-sm font-medium transition shadow-sm \${todayStatus === false ? "bg-red-100 border-red-300" : "bg-white border-gray-300 hover:bg-gray-100"}\`}
                    onClick={() => markToday(false)}
                  >
                    I watched
                  </button>
                  {todayStatus !== undefined && (
                    <button
                      className="px-3 py-2 rounded-xl border text-sm text-gray-600 hover:bg-gray-100"
                      onClick={undoToday}
                    >
                      Undo
                    </button>
                  )}
                </div>
              </div>
              <div className="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3">
                <Stat
                  label="Current streak"
                  value={\`\${currentStreak} day\${currentStreak === 1 ? "" : "s"}\`}
                  hint={todayStatus === undefined ? \`Mark today to reach \${projectedStreakIfSuccessToday}\` : undefined}
                />
                <Stat label="Best streak" value={\`\${bestStreak} days\`} />
                <Stat
                  label="Today"
                  value={
                    todayStatus === true ? "Didn't watch" :
                    todayStatus === false ? "Watched" : "Not set"
                  }
                />
              </div>
            </div>

            <section className="mb-8">
              <h2 className="text-xl font-semibold mb-3">History</h2>
              <div className="grid md:grid-cols-3 gap-4">
                {monthDates.map((monthDate) => (
                  <MonthGrid key={monthDate.getTime()} date={monthDate} entries={entries} />
                ))}
              </div>
              <Legend />
            </section>

            <footer className="text-xs text-gray-500 mt-6">
              Your data never leaves this device. Stored via localStorage.
            </footer>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<ReelsTrackerApp />);
  </script>
</body>
</html>
